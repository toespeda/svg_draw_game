<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title>Test</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <style>
            html, body {
                height:100%;
            }
            body {
                margin:0;
                padding: 10px;
                background-color: #eee;
                padding: 0;
                margin: 0;
            }
            #editor {

            }
            .col {
                padding: 10px;
                float: left;
            }
            .row {
                clear: left;
            }
            svg {
                background-color: #fff;
            }
            #layers {
                margin: 0;
                padding: 5px 0 10px 15px;
            }
            #layers li {
                cursor: default;
            }
            #layers .remove {
                cursor: pointer;
                margin:0 5px;
            }
            #controllers {

                padding: 10px 0;
            }
            #examples {
                float: right;
            }
            #examples svg {
                width: 80px;
                height: 80px;
            }
            #letters {
                /*display:grid;*/
                /*grid-auto-flow:column dense;*/
                /*grid-template-rows:50px 50px;*/
                /*grid-auto-columns:50px;*/
            }
            #letters > * {
                width: 32px;
                height: 32px;
                margin: 4px;
                box-shadow: 2px 2px 1px #000;
            }
            #letters > *.picked {
                border-color: transparent;
                background-color: transparent;
                box-shadow:none;
            }
            #result {
                margin:0 0 30px 0;
            }
            #result > * {
                display: inline-block;
                width: 32px;
                height: 32px;
                margin: 4px;
                border-bottom: 3px solid #000;
                font-size: 20px;
                text-align: center;
                vertical-align: middle;
            }
            #result > *.ok {
                border-bottom-color: transparent;
            }
            #tools {
                background-color: #ccc;
                padding: 5px;
            }
            #tools:after {
                clear: both;
                content: "";
                display: table;
            }
            #tools img {
                padding: 5px;
                float: left;
                border: 1px solid transparent;
                border-radius: 5px;

                margin: 0 5px 0 0;
            }
            #tools img:hover {
                background-color: #fff;
            }
            #tools img.active {
                box-shadow: 2px 2px 1px #000;
            }


        </style>
    </head>
    <body>

        <div class="row">

            <div id="editor" class="test col">

                <div id="tools">
                    <img data-action="move" src="symbols/pointer.svg" />
                    <img data-action="resize" src="symbols/resize.svg" />
                    <img data-action="draw" data-type="line" src="symbols/line.svg" />
                    <img data-action="draw" data-type="circle" src="symbols/circle.svg" />
                    <img data-action="draw" data-type="ellipse" src="symbols/ellipse.svg" />
                    <img data-action="draw" data-type="symbol" src="symbols/star.svg" />
                </div>

                <svg xmlns="http://www.w3.org/2000/svg" width="358" height="358" viewBox="0 0 358 358">

                    <path stroke="#000000" stroke-width="3" fill="transparent" d="
                        M 93.11,36.46
                        C 92.79,35.45 91.94,34.72 90.94,34.61
                        L 61.53,31.46 49.6,2.911
                        C 49.19,1.943 48.28,1.308 47.27,1.308 46.26,1.308 45.35,1.937 44.94,2.916
                        L 33.01,31.46 3.6,34.61
                        C 2.597,34.72 1.746,35.45 1.436,36.46 1.122,37.47 1.407,38.59 2.161,39.3
                        L 24.2,60.1 17.95,90.59
                        C 17.74,91.63 18.13,92.71 18.94,93.33 19.39,93.68 19.91,93.85 20.44,93.85 20.88,93.85 21.32,93.73 21.72,93.48
                        L 47.27,77.78 72.82,93.48
                        C 73.69,94.01 74.78,93.96 75.6,93.32 76.41,92.71 76.8,91.62 76.59,90.58
                        L 70.34,60.08 92.38,39.28
                        C 93.13,38.58 93.42,37.47 93.11,36.46
                        Z "/>

                </svg>
            </div>

            <div class="col">
                <ol id="layers"></ol>
                <button id="reverse">Reverse</button>
            </div>

            <div id="examples" class="col">
                <svg xmlns="http://www.w3.org/2000/svg" width="358" height="358" viewBox="0 0 358 358">
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M246 176 L235 80"></path>
                    <circle stroke="#000000" stroke-width="3" fill="transparent" cx="182" cy="124" r="36.235341863986875"></circle>
                    <ellipse stroke="#000000" stroke-width="3" fill="transparent" cx="100" cy="132" rx="36" ry="52.5"></ellipse>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" width="358" height="358" viewBox="0 0 358 358">
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M152 50 L84 121" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M152 50 L236 110" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M84 121 L128 124" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M128 124 L70 177" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M185 121 L244 165" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M192 185 L244 165" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M44 280 L126 183" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M280 270 L189 184" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M280 270 L187 288" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M236 110 L185 121" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M126 183 L70 177" opacity="1"></path>
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M44 280 L134 291" opacity="1"></path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" width="358" height="358" viewBox="0 0 358 358">
                    <path stroke="#000000" stroke-width="3" fill="none" stroke-linejoin="round" d="M246 176 L235 80, 265 80, 235 40 C235 80, 225 80, 225 80"></path>
                </svg>
            </div>

        </div>

        <div class="row">

            <div class="col">

                <div id="controllers">
                    <button id="test">Test</button>
                </div>

                <div id="result"></div>

                <div id="letters"></div>

            </div>

        </div>

        <script type="application/javascript" src="SVGDraw.js"></script>
        <script type="application/javascript" src="Sortable.js"></script>
        
        <script>

            let svg = document.querySelector("#editor svg");

            let Draw = new SVGDraw(svg);

            let layers = document.querySelector("#layers");

            let tools = document.querySelector("#tools");

            let setTools = function(data){
                for (var i in data) {
                    tools.querySelectorAll("[data-"+i+"]").forEach(el => {
                        el.classList[el.dataset[i] === data[i] ? "add" : "remove"]("active");
                    });
                }
            };

            svg.addEventListener("action", (e) => {
                setTools({
                    action:e.detail
                });
            }, false);

            tools.addEventListener("click", (e) => {
                if (e.target.nodeName.toLowerCase()==="img") {
                    let data = e.target.dataset;
                    Draw.set(data);
                    setTools(data);
                }
            });

            document.addEventListener("keyup", (e) => {

                if (e.key === "1") {
                    Draw.type = "line";
                }
                if (e.key === "2") {
                    Draw.type = "circle";
                }
                if (e.key === "3") {
                    Draw.type = "ellipse";
                }
                if (e.key === "4") {
                    Draw.type = "path";
                }
                if (e.key === "l") {
                    Draw.draw = 1;
                }
                if (e.key === "m") {
                    Draw.draw = 0;
                }
                // if (e.key === "Delete") {
                //     console.log(Shape);
                // }
            });

            Sortable(layers);

            layers.addEventListener("sorted", (e) => {
                //Rearrange shapes
                Draw.moveShape(e.detail.startIndex, e.detail.endIndex);
            }, false);

            layers.addEventListener("removed", (e) => {
                //Rearrange shapes
                Draw.removeShape(e.detail.index);

            }, false);

            svg.addEventListener("added", (e) => {
                let b = document.createElement('li');
                b.innerHTML = e.detail.type + '<span class="remove">x</span>';
                layers.appendChild(b);
            }, false);

            document.querySelector("#reverse").addEventListener("click", e => {
                e.preventDefault();
                Draw.reverseOrder();
                for (var i = 1; i < layers.childNodes.length; i++){
                    layers.insertBefore(layers.childNodes[i], layers.firstChild);
                }
            });

            document.querySelector("#test").addEventListener("click", e => {
                e.preventDefault();
                let shapes = [...svg.children];
                [...layers.children].forEach(el => {
                    el.style.fontWeight = "";
                });
                let test = e.target;
                if (test.innerText==="Stop") {
                    test.innerText = "Test";
                    shapes.forEach(el=>{
                        el.setAttribute("opacity","1");
                    });
                    test.nextSibling.remove();
                    [...layers.children].forEach(el => {
                        el.style.fontWeight = "";
                    });
                } else {
                    test.innerText = "Stop";
                    shapes.forEach(el=>{
                        el.setAttribute("opacity",".3");
                    });
                    let i = 0;
                    let next = document.createElement("button");
                    next.innerText = "Next";
                    test.parentNode.insertBefore(next, test.nextSibling);
                    next.addEventListener("click", e => {
                        shapes[i].setAttribute("opacity","1");
                        layers.children[i].style.fontWeight = "bold";
                        if (!shapes[++i]) {
                            next.remove();
                            test.innerText = "Test";
                        }
                    });
                }
            });

            Draw.addShapes();

            let examples = document.querySelector("#examples");

            examples.addEventListener("click", e => {
                if (e.target.nodeName === "svg") {
                    layers.innerHTML = "";
                    Draw.addShapes(e.target.innerHTML);
                }
            });

            layers.addEventListener("mouseover", (e) => {
                let shape = Draw.getShapeByIndex([...layers.childNodes].indexOf(e.target));
                if (shape) {
                    shape.el.setAttribute("stroke", "#ff0000")
                }
            });

            layers.addEventListener("mouseout", (e) => {
                let shape = Draw.getShapeByIndex([...layers.childNodes].indexOf(e.target));
                if (shape) {
                    shape.el.setAttribute("stroke", "#000000")
                }
            });









            let letters = document.querySelector("#letters");

            let alpha = [...'abcdefghijklmnopqrstuvwxyz'];

            let word = "test";



            let result = document.querySelector("#result");

            [...word].forEach(b => {
                let box = document.createElement("span");
                result.appendChild(box);
            });

            for (var i in alpha) {
                if (+i === Math.floor(alpha.length/2)) {
                    letters.appendChild(document.createElement("br"));
                }
                let e = document.createElement("button");
                e.textContent = alpha[i];
                letters.appendChild(e);
            }

            letters.addEventListener("click", e => {
                let target = e.target;
                target.classList.add("picked");
                let l = target.textContent;
                let r = new RegExp(l,"gi");
                let match = [];
                let matches = [];
                while ((match = r.exec(word)) !== null) {
                    matches.push(match);
                };
                if (matches.length) {
                    matches.forEach(m => {
                        let ok = result.children[m.index];
                        ok.textContent = l;
                        ok.classList.add("ok");
                        console.log("matches", m.index);
                    })
                }

            });


        </script>
        
    </body>
</html>